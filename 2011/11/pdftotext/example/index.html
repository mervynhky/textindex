<html>
<meta charset="UTF-8">
<head>
    <link rel="stylesheet" href="../annotator.css">
    <link rel="stylesheet" href="../jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="assets/reset.css"/>
    <link rel="stylesheet" type="text/css" href="assets/styles.css"/>
    <link rel="stylesheet" type="text/css" href="assets/github.css"/>
    <link rel="stylesheet" type="text/css" href="assets/ColorPicker.css"/>
    <script type="text/javascript" src="assets/rainbow-custom.min.js"></script>
    <script type="text/javascript" src="assets/ColorPicker.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            overflow-y: hidden;
            padding: 0;
            margin: 0;
        }

        body {
            font: 13px Helvetica, sans-serif;
        }

        body > div {
            width: 48%;
            height: 100%;
            overflow-y: auto;
            display: inline-block;
            vertical-align: top;
        }

        iframe {
            border: none;
            width: 100%;
            height: 100%;
        }

        #output {
            visibility: hidden;
            font-family: "Franklin Gothic Heavy";
            font-size: 16px;
            text-align: justify;
            padding: 20px;
            box-shadow: 0 0 5px #777;
            border-radius: 5px;
            margin: 10px;
        }

        #processor {
            height: 70px;
        }

        .button {
            -moz-border-radius: 4px;
            -webkit-border-radius: 4px;
            border-radius: 10px;
            box-shadow: 0 0 5px #777;
            margin-top: 15px;
            /*z-index: 99999;*/
        }

        #inputstuff {
            position: absolute;
            /*background-color: transparent;*/
            /*border-bottom: 10px none;*/
            /*box-shadow: 0 4px 2px -2px #777;*/
            height: 90%;
            text-align: center;
            width: 50%;
            margin-top: 40px;
            overflow: auto;
        }

        #copiedText {
            margin: 10px;
            margin-top: 65px;
            text-align: justify;
            font-family: 'Century Gothic';
            font-size: 16px;
        }

        .annotator-notice {
            width: 0px !important;
        }

        .ui-autocomplete-input {
            z-index: 9999999 !important;
        }

    </style>
</head>
<!--ondblclick="annotate(getPosition())"-->
<body>
<div style="overflow-y: hidden!important;">
    <div id="inputstuff">
        Change highlighting color:
        <div class="color-picker"></div>
        Remove all highlights:
        <button id="remove">Remove</button>

        <button style="margin-left:10px;" id="clearPg" onclick="clearPg();">Clear Page</button>
        <button style="margin-left:14px;" id="highLight" onclick="highLight();">Highlighter</button>
        <p>Current Connectivity: <span id="status"></span></p>
        <!--<input class="button" type="button" onclick="highlightSelection()" value="Highlight with div">-->
        <!--<input class="button" type="button" onclick="surroundSelection()" value="Highlight with span">-->
        <input class="button" type="button" onclick="copyText()" value="Show Text">
        <input class="button" type="button" onclick="getPosition()" value="Get position">
        <!--<input class="button" type="button" onclick="annotate()" value="Annotate">-->
        <input class="button" type="button" onclick="retrieveTag()" value="Retrieve Tag">
        <input class="button" type="button" onclick="startStore()" value="Annotate">
        <!--<input class="button" type="button" onclick="drawStorage()" value="Get Stored">-->
        <!--<input class="button" type="button" onclick="refresher()" value="Refresher Orb">-->
        <!--<input class="button" type="button" onclick="testCopy()" value="Test Copy">-->

        <div id="copiedText"></div>
    </div>
    <!-- embed the pdftotext web app as an iframe visibility:hidden; display:none;-->
    <iframe id="processor" src="../"
            style="position: absolute; overflow: hidden;"></iframe>

    <!-- a container for the output -->
    <div id="output" style="margin-top: 2600px;">
        super nugget
    </div>
</div>

<div>
    <button style="margin-left:150px; margin-top:60px;" id="clear-storage">Clear LocalStorage</button>
    <div id="thelabels" style="margin-left:50px; margin-top:35px;"> The Labels:
        <div id="labelstuff" style="font-family:sans-serif; font-size: 12px;">
        </div>
    </div>
    <!-- the PDF file must be on the same domain as this page -->
    <iframe id="input" src="Journal.pdf" style="visibility:hidden; width:1px; height:1px;"></iframe>
</div>
<script src="../jQuery-1.7.js"></script>
<script src="../jquery-ui.js"></script>
<script src="http://assets.annotateit.org/annotator/v1.2.5/annotator-full.min.js"></script>
<script src="TextHighlighter.min.js"></script>
<script type="text/javascript">

    function clearPg() {
        var jqDiv = document.getElementById("output");
        jqDiv.innerHTML = "";
        jqDiv.textContent = "";
    }

    function highLight() {
        (function () {
            var removeBtn = document.getElementById('remove');
            var sandbox = document.getElementById('copiedText');
            var colors = new ColorPicker(document.querySelector('.color-picker'));
            var hltr = new TextHighlighter(sandbox);


//            sandbox.addEventListener('mousedown', jQuery(function ($) {
//                $('#copiedText').annotator();
//            }));

            colors.onColorChange(function (color) {
                hltr.setColor(color);
            });

            removeBtn.addEventListener('click', function () {
                hltr.removeHighlights();
            });
        })();
    }

    function highlightSelection() {
        var userSelection = window.getSelection().getRangeAt(0);
        highlightRange(userSelection);
    }

    function highlightRange(range) {
        var newNode = document.createElement("div");
        newNode.setAttribute(
                "style",
                "background-color: yellow; display: inline;"
        );
        range.surroundContents(newNode);
    }

    function surroundSelection() {
        var span = document.createElement("span");
        span.id = "marker";
        span.style.fontWeight = "bold";
        span.style.color = "green";
        span.style.backgroundColor = "yellow";
        if (window.getSelection) {
            var sel = window.getSelection();
            if (sel.rangeCount) {
                var range = sel.getRangeAt(0).cloneRange();
                range.surroundContents(span);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    }

    function getCharOffsetRelativeTo(container, node, offset) {
        var range = document.createRange();
        range.selectNodeContents(container);
        range.setEnd(node, offset);
        return range.toString().length;
    }

    function copyText() {
        var outputbox = document.getElementById("output");
        var newbox = document.getElementById("copiedText");
        outputbox.innerHTML = newbox.innerHTML = outputbox.innerHTML;
    }

    function refresher() {
        var copiedText = document.getElementById("copiedText");
        var annotator = new Annotator(copiedText);
        annotator.destroy;
        $('#copiedText').load(document.URL + ' #copiedText');
        $('#status').load(document.URL + ' #status');
        annotator.destroy;
    }

    function getPosition() {
        var sel = window.getSelection();
        var pre = document.getElementById("copiedText");
        var length = document.getSelection().toString().length;
        var offset = getCharOffsetRelativeTo(pre, sel.anchorNode, sel.anchorOffset);
        console.log("Offset is: " + offset);
        var text = "";
        if (typeof window.getSelection != "undefined") {
            if (sel.rangeCount) {
                text = sel.toString();
            }
        } else if (typeof document.selection != "undefined" &&
                document.selection.type != "Control") {
            var textRange = document.selection.createRange();
            text = textRange.text;
        }
        annotate(offset, text, length);
    }

    function annotate(offset, text, length) {
        jQuery(function ($) {
            $('#copiedText').annotator().annotator('addPlugin', 'Tags');
            var availableTags = [offset.toString(),];
            $('#copiedText').data('annotator').plugins.Tags.input.autocomplete({
                source: availableTags
            });
        });
        var labelbox = document.getElementById("labelstuff");
        labelbox.innerHTML = labelbox.innerHTML + "<br/> WORD: " + text + "<br/> OFFSET IS: " + offset.toString() + "<br/> LEGNTH IS: " + length.toString() + "<br/>";
    }

    function retrieveTag() {
        var highlighted = window.getSelection();
        var tagged = document.getElementsByClassName("annotator-tags");
        var text = "";
        for (var b = 0; b < tagged.length; b++) {
            var tagText = tagged[b].innerText;
        }
        if (typeof window.getSelection != "undefined") {
            if (highlighted.rangeCount) {
                text = highlighted.toString();
            }
        } else if (typeof document.selection != "undefined" &&
                document.selection.type != "Control") {
            var textRange = document.selection.createRange();
            text = textRange.text;
        }
        var labelbox = document.getElementById("labelstuff");
        labelbox.innerHTML = labelbox.innerHTML + "<br/> WORD: " + text + " <br/> TAGGED WITH: " + tagText + "<br/>";
    }

</script>

<!-- TODO: set the coffeescript to be toggled or delayed-->

<script src="vendor/coffeescript.js"></script>
<script type="text/coffeescript">
#For this section, it is set to a trigger type
#The next step is to trigger this to be on or off
    root = exports ? this
    root.startStore = () ->
#        wording = $("#copiedText")
#        destroyer = new Annotator(wording)
#        destroyer.destroy
        wording = undefined
        modules = undefined
        requests = undefined
        run = undefined
        script = undefined
        sources = undefined

        window.onerror = (msg, file, line) ->
            alert msg + ' ' + file + ' ' + line

        jQuery.ajaxSetup async: false
        modules = jQuery.trim('offline offline/store')
        modules = modules.split(/\s+/)

        run = (file, source) ->
            compiled = undefined
            filename = undefined
            filename = file.replace(/coffee$/, 'js')
            compiled = CoffeeScript.compile(source) + '\n//@ sourceURL=' + filename
            eval compiled

        sources = do ->
            i = undefined
            len = undefined
            results = undefined
            results = []
            i = 0
            len = modules.length
            while i < len
                script = modules[i]
                results.push './src/' + script + '.coffee'
                i++
            results
        requests = jQuery.map(sources, (script) ->
            jQuery.get script, jQuery.proxy(run, this, script)
        )
        jQuery.when.apply(jQuery, requests).done ->
            content = undefined
            content = jQuery('#copiedText').annotator()
            content.annotator 'addPlugin', 'Offline',
                online: ->
                    jQuery('#status').text 'Online'
                offline: ->
                    jQuery('#status').text 'Offline'
            window.annotator = content.data('annotator')
        jQuery('#clear-storage').click ->
            if window.annotator
                return window.annotator.plugins.Offline.store.clear()
            return
        return

</script>
<script>

    var input = document.getElementById("input");
    var processor = document.getElementById("processor");
    var output = document.getElementById("output");

    window.addEventListener("message", function (event) {
        if (event.source != processor.contentWindow) return;

        switch (event.data) {
            case "ready":
                var xhr = new XMLHttpRequest;
                xhr.open('GET', input.getAttribute("src"), true);
                xhr.responseType = "arraybuffer";

                xhr.onload = function (event) {
                    processor.contentWindow.postMessage(this.response, "*");
                };

                xhr.send();
                break;

            default:
                output.textContent = event.data.replace(/\s+/g, " ");
                break;
        }
    }, true);
</script>
</body>
</html>
